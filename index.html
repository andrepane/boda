<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nuestra boda</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app-shell">
      <div class="app">
        <header class="app__header">
          <div class="hero">
            <div class="hero__accent"></div>
            <div class="hero__content">
              <span class="hero__badge" aria-hidden="true">Organización</span>
              <h1 class="hero__title">Boda</h1>
              <p class="hero__subtitle">
                Un lugar para coordinar ideas, invitados y presupuesto con calma y estilo.
              </p>
            </div>
          </div>

          <nav class="tabs" aria-label="Secciones de la aplicacion">
            <button
              id="checklist-tab"
              class="tabs__tab is-active"
              type="button"
              data-target="checklist"
              aria-controls="checklist"
              aria-selected="true"
            >
              Checklist
            </button>
            <button
              id="ideas-tab"
              class="tabs__tab"
              type="button"
              data-target="ideas"
              aria-controls="ideas"
              aria-selected="false"
            >
              Ideas
            </button>
            <button
              id="invitados-tab"
              class="tabs__tab"
              type="button"
              data-target="invitados"
              aria-controls="invitados"
              aria-selected="false"
            >
              Invitados
            </button>
            <button
              id="presupuesto-tab"
              class="tabs__tab"
              type="button"
              data-target="presupuesto"
              aria-controls="presupuesto"
              aria-selected="false"
            >
              Presupuesto
            </button>
          </nav>
        </header>

        <main class="app__content">
          <section id="checklist" class="tab-content is-active" role="tabpanel" aria-labelledby="checklist-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Checklist</h2>
                <p class="panel__subtitle">
                  Añade tareas, marca lo completado y mantente al tanto de los pendientes.
                </p>
              </header>

              <form class="checklist__form" id="task-form" autocomplete="off">
                <div class="checklist__field checklist__field--full">
                  <label class="checklist__label" for="task-input">Tarea</label>
                  <input
                    id="task-input"
                    class="checklist__control"
                    type="text"
                    placeholder="Describe la tarea"
                    required
                  />
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-category">Categoría</label>
                  <select id="task-category" class="checklist__control" required>
                    <option value="decoracion">Decoración</option>
                    <option value="papeleo">Papeleo</option>
                    <option value="catering">Catering</option>
                    <option value="viaje-de-novios">Viaje de novios</option>
                    <option value="anillos">Anillos</option>
                    <option value="vestimenta">Vestimenta</option>
                    <option value="invitados">Invitados</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-priority">Prioridad</label>
                  <select id="task-priority" class="checklist__control" required>
                    <option value="alta">Alta</option>
                    <option value="media" selected>Media</option>
                    <option value="baja">Baja</option>
                  </select>
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-deadline">Fecha límite</label>
                  <input id="task-deadline" class="checklist__control" type="date" required />
                </div>

                <button class="button checklist__submit" type="submit">Agregar</button>
              </form>

              <div class="checklist__summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Pendientes</span>
                  <strong id="pending-count" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Total</span>
                  <strong id="total-count" class="summary__value">0</strong>
                </div>
                <div class="checklist__progress">
                  <div class="progress__header">
                    <span class="summary__label">Progreso</span>
                    <strong id="progress-value" class="summary__value">0%</strong>
                  </div>
                  <div
                    id="progress-bar"
                    class="progress__bar"
                    role="progressbar"
                    aria-label="Progreso de la checklist"
                    aria-valuemin="0"
                    aria-valuemax="100"
                    aria-valuenow="0"
                  >
                    <div id="progress-fill" class="progress__fill"></div>
                  </div>
                </div>
              </div>

              <ul class="checklist__list" id="task-list"></ul>
            </div>
          </section>

          <section id="ideas" class="tab-content" role="tabpanel" aria-labelledby="ideas-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Ideas y inspiracion</h2>
                <p class="panel__subtitle">
                  Galeria para anotar estilos, colores y proveedores favoritos.
                </p>
              </header>

              <div class="gallery">
                <article class="gallery__card">
                  <h3 class="gallery__title">Decoracion</h3>
                  <p class="gallery__text">
                    Guarda links a arreglos florales, seating charts o invitaciones que te gusten.
                  </p>
                </article>
                <article class="gallery__card">
                  <h3 class="gallery__title">Momentos clave</h3>
                  <p class="gallery__text">
                    Escribe ideas para la ceremonia, discursos o una cancion especial para el primer baile.
                  </p>
                </article>
                <article class="gallery__card">
                  <h3 class="gallery__title">Lista de deseos</h3>
                  <p class="gallery__text">
                    Añade referencias para recuerdos, detalles de mesas o sorpresas para invitados.
                  </p>
                </article>
              </div>
            </div>
          </section>

          <section id="invitados" class="tab-content" role="tabpanel" aria-labelledby="invitados-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Invitados</h2>
                <p class="panel__subtitle">
                  Prepara una lista maestra y anota confirmaciones o necesidades especiales.
                </p>
              </header>

              <div class="info-card">
                <p class="info-card__line">Crea grupos por familias, amigos y trabajo.</p>
                <p class="info-card__line">Marca asistentes confirmados y acompanantes.</p>
                <p class="info-card__line">Exporta la lista para coordinar las mesas.</p>
              </div>
            </div>
          </section>

          <section id="presupuesto" class="tab-content" role="tabpanel" aria-labelledby="presupuesto-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Presupuesto</h2>
                <p class="panel__subtitle">
                  Establece tu presupuesto objetivo y controla gastos estimados y reales.
                </p>
              </header>

              <div class="budget-grid">
                <article class="budget-card">
                  <h3 class="budget-card__title">Vista general</h3>
                  <p class="budget-card__text">
                    Divide el presupuesto entre catering, musica, fotografia y otros rubros clave.
                  </p>
                </article>
                <article class="budget-card">
                  <h3 class="budget-card__title">Control mensual</h3>
                  <p class="budget-card__text">
                    Haz seguimiento de pagos y fechas limites para evitar sorpresas de ultimo momento.
                  </p>
                </article>
                <article class="budget-card">
                  <h3 class="budget-card__title">Ahorros e imprevistos</h3>
                  <p class="budget-card__text">
                    Reserva un porcentaje para detalles de ultima hora o mejoras de experiencia.
                  </p>
                </article>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script>
      // ⚠️ Rellena con TUS credenciales reales. MUY IMPORTANTE: añade también databaseURL.
      // - databaseURL: cópiala desde Firebase → Realtime Database → pestaña "Data".
      // - storageBucket debe acabar en .appspot.com
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyCKHtBq_JjgYSy-lpnpka8jNpaW4GbMefU",
        authDomain: "boda-f0cac.firebaseapp.com",
        databaseURL: "https://boda-f0cac-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "boda-f0cac",
        storageBucket: "boda-f0cac.appspot.com",
        messagingSenderId: "764003731377",
        appId: "1:764003731377:web:5dccc6fa01c0409121df90",
        // measurementId opcional
      };

      // Encendido / apagado de la sync remota sin tocar más código
      window.ENABLE_SYNC = true;

      // Sala compartida entre vosotros
      window.DEFAULT_ROOM_ID = "andrea-boda";
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        push,
        update,
        remove,
        onValue,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      const firebaseConfig = window.FIREBASE_CONFIG;
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const ROOM = window.DEFAULT_ROOM_ID || "andrea-boda";
      const tasksPath = `rooms/${ROOM}/tasks`;

      function ensureSync() {
        if (!window.ENABLE_SYNC) {
          throw new Error("SYNC_OFF");
        }
      }

      let resolveAuthReady;
      let rejectAuthReady;
      const authReadyPromise = new Promise((resolve, reject) => {
        resolveAuthReady = resolve;
        rejectAuthReady = reject;
      });

      signInAnonymously(auth).catch((error) => {
        console.error("Error al iniciar sesión de forma anónima.", error);

        if (typeof rejectAuthReady === "function") {
          rejectAuthReady(error);
          resolveAuthReady = null;
          rejectAuthReady = null;
        }
      });

      onAuthStateChanged(
        auth,
        (user) => {
          if (user && user.uid) {
            console.debug("Firebase Auth listo. UID:", user.uid);

            if (typeof resolveAuthReady === "function") {
              resolveAuthReady(user);
              resolveAuthReady = null;
              rejectAuthReady = null;
            }
          }
        },
        (error) => {
          console.error("Error al observar el estado de autenticación.", error);

          if (typeof rejectAuthReady === "function") {
            rejectAuthReady(error);
            resolveAuthReady = null;
            rejectAuthReady = null;
          }
        },
      );

      const waitForAuth = () => authReadyPromise;

      export function listenTasks(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const tasksRef = ref(db, tasksPath);
            unsubscribe = onValue(
              tasksRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en las tareas de Firebase.", error);
              },
            );
          })
          .catch((error) => {
            console.error(
              "No se pudo iniciar la escucha de tareas porque la autenticación falló.",
              error,
            );
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addTask(task) {
        await waitForAuth();
        ensureSync();

        const tasksRef = ref(db, tasksPath);
        const payload = {
          description: String(task.description ?? "").trim(),
          category: task.category ?? "otro",
          priority: task.priority ?? "media",
          dueDate: task.dueDate ?? "",
          completed: Boolean(task.completed),
          createdAt:
            typeof task.createdAt === "number" && Number.isFinite(task.createdAt)
              ? task.createdAt
              : Date.now(),
          updatedAt:
            typeof task.updatedAt === "number" && Number.isFinite(task.updatedAt)
              ? task.updatedAt
              : Date.now(),
          id: typeof task.id === "string" && task.id ? task.id : null,
        };

        try {
          await push(tasksRef, payload);
        } catch (error) {
          console.error("No se pudo crear la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function toggleTask(taskId, completed) {
        await waitForAuth();
        ensureSync();

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await update(taskRef, {
            completed: Boolean(completed),
            updatedAt: Date.now(),
          });
        } catch (error) {
          console.error("No se pudo actualizar la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function deleteTask(taskId) {
        await waitForAuth();
        ensureSync();

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await remove(taskRef);
        } catch (error) {
          console.error("No se pudo eliminar la tarea en Firebase.", error);
          throw error;
        }
      }

      window.FirebaseSync = {
        listenTasks,
        addTask,
        toggleTask,
        deleteTask,
      };

      if (typeof window !== "undefined" && typeof window.dispatchEvent === "function") {
        window.dispatchEvent(new Event("firebase-sync-ready"));
      }
    </script>


    <script src="app.js" defer></script>
  </body>
</html>


