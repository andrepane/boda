<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f7f1ec" />
    <meta name="description" content="Organiza tu boda con checklist, cronograma, ideas, lugares, invitados y presupuesto." />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Nuestra Boda" />
    <title>Nuestra boda</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icons/icon-32.png" />
    <link rel="apple-touch-icon" href="icons/icon-180.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app-shell">
      <div class="app">
        <header class="app__header">
          <div class="hero">
            <div class="hero__accent"></div>
            <div class="hero__content">
              <span class="hero__badge" aria-hidden="true">Organización</span>
              <h1 class="hero__title">Boda</h1>
              <p class="hero__subtitle">
                Un lugar para coordinar ideas, invitados y presupuesto con calma y estilo.
              </p>
            </div>
          </div>

          <nav class="tabs" aria-label="Secciones de la aplicacion">
            <button
              id="checklist-tab"
              class="tabs__tab is-active"
              type="button"
              data-target="checklist"
              aria-controls="checklist"
              aria-selected="true"
            >
              Checklist
            </button>
            <button
              id="cronograma-tab"
              class="tabs__tab"
              type="button"
              data-target="cronograma"
              aria-controls="cronograma"
              aria-selected="false"
            >
              Cronograma
            </button>
            <button
              id="ideas-tab"
              class="tabs__tab"
              type="button"
              data-target="ideas"
              aria-controls="ideas"
              aria-selected="false"
            >
              Ideas
            </button>
            <button
              id="lugares-tab"
              class="tabs__tab"
              type="button"
              data-target="lugares"
              aria-controls="lugares"
              aria-selected="false"
            >
              Lugares
            </button>
            <button
              id="invitados-tab"
              class="tabs__tab"
              type="button"
              data-target="invitados"
              aria-controls="invitados"
              aria-selected="false"
            >
              Invitados
            </button>
            <button
              id="presupuesto-tab"
              class="tabs__tab"
              type="button"
              data-target="presupuesto"
              aria-controls="presupuesto"
              aria-selected="false"
            >
              Presupuesto
            </button>
            <button
              id="viaje-tab"
              class="tabs__tab"
              type="button"
              data-target="viaje"
              aria-controls="viaje"
              aria-selected="false"
            >
              Viaje
            </button>
          </nav>
        </header>

        <main class="app__content">
          <section id="checklist" class="tab-content is-active" role="tabpanel" aria-labelledby="checklist-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Checklist</h2>
                <p class="panel__subtitle">
                  Añade tareas, marca lo completado y mantente al tanto de los pendientes.
                </p>
              </header>

              <form class="checklist__form" id="task-form" autocomplete="off">
                <div class="checklist__field checklist__field--full">
                  <label class="checklist__label" for="task-input">Tarea</label>
                  <input
                    id="task-input"
                    class="checklist__control"
                    type="text"
                    placeholder="Describe la tarea"
                    required
                  />
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-category">Categoría</label>
                  <select id="task-category" class="checklist__control" required>
                    <option value="decoracion">Decoración</option>
                    <option value="papeleo">Papeleo</option>
                    <option value="catering">Catering</option>
                    <option value="viaje-de-novios">Viaje de novios</option>
                    <option value="anillos">Anillos</option>
                    <option value="vestimenta">Vestimenta</option>
                    <option value="invitados">Invitados</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-priority">Prioridad</label>
                  <select id="task-priority" class="checklist__control" required>
                    <option value="alta">Alta</option>
                    <option value="media" selected>Media</option>
                    <option value="baja">Baja</option>
                  </select>
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-deadline">Fecha límite</label>
                  <input id="task-deadline" class="checklist__control" type="date" required />
                </div>

                <button class="button checklist__submit" type="submit">Agregar</button>
              </form>

              <div class="checklist__summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Pendientes</span>
                  <strong id="pending-count" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Total</span>
                  <strong id="total-count" class="summary__value">0</strong>
                </div>
                <div class="checklist__progress">
                  <div class="progress__header">
                    <span class="summary__label">Progreso</span>
                    <strong id="progress-value" class="summary__value">0%</strong>
                  </div>
                  <div
                    id="progress-bar"
                    class="progress__bar"
                    role="progressbar"
                    aria-label="Progreso de la checklist"
                    aria-valuemin="0"
                    aria-valuemax="100"
                    aria-valuenow="0"
                  >
                    <div id="progress-fill" class="progress__fill"></div>
                  </div>
                </div>
              </div>

              <ul class="checklist__list" id="task-list"></ul>
            </div>
          </section>

          <section id="cronograma" class="tab-content" role="tabpanel" aria-labelledby="cronograma-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Cronograma</h2>
                <p class="panel__subtitle">
                  Define hitos, asigna responsables y controla recordatorios para mantener el ritmo de la organización.
                </p>
              </header>

              <form id="milestone-form" class="form-grid timeline-form" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="milestone-title">Hito</label>
                  <input
                    id="milestone-title"
                    class="form-control"
                    type="text"
                    placeholder="Reunión con el catering, prueba de vestido…"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="milestone-date">Fecha</label>
                  <input id="milestone-date" class="form-control" type="date" required />
                </div>

                <div class="form-field">
                  <label class="form-label" for="milestone-status">Estado</label>
                  <select id="milestone-status" class="form-control" required>
                    <option value="planned" selected>Planificado</option>
                    <option value="in-progress">En curso</option>
                    <option value="done">Completado</option>
                  </select>
                </div>

                <div class="form-field">
                  <label class="form-label" for="milestone-responsibles">Responsables</label>
                  <input
                    id="milestone-responsibles"
                    class="form-control"
                    type="text"
                    placeholder="Nombres separados por coma"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="milestone-reminder">Recordatorio</label>
                  <select id="milestone-reminder" class="form-control" required>
                    <option value="none" selected>Sin recordatorio</option>
                    <option value="1w">Una semana antes</option>
                    <option value="3d">Tres días antes</option>
                    <option value="1d">Un día antes</option>
                  </select>
                </div>

                <button class="button form-submit timeline-form__submit" type="submit">Agregar hito</button>
              </form>

              <div class="timeline-summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Planificados</span>
                  <strong id="milestone-planned" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">En curso</span>
                  <strong id="milestone-in-progress" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Completados</span>
                  <strong id="milestone-done" class="summary__value">0</strong>
                </div>
              </div>

              <ol id="timeline-list" class="timeline" aria-live="polite"></ol>
            </div>
          </section>

          <section id="ideas" class="tab-content" role="tabpanel" aria-labelledby="ideas-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Ideas e inspiración</h2>
                <p class="panel__subtitle">
                  Guarda referencias de decoración, proveedores y detalles especiales.
                </p>
              </header>

              <form id="idea-form" class="form-grid ideas-form" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-title">Título o descripción</label>
                  <input
                    id="idea-title"
                    class="form-control"
                    type="text"
                    placeholder="Centro de mesa, invitaciones…"
                    required
                  />
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-images">Imágenes</label>
                  <input
                    id="idea-images"
                    class="form-control form-control--file"
                    type="file"
                    accept="image/*"
                    multiple
                  />
                  <p class="form-hint">Sube imágenes desde tu dispositivo para crear tu tablero visual.</p>
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-url">Enlace (opcional)</label>
                  <input
                    id="idea-url"
                    class="form-control"
                    type="url"
                    placeholder="https://"
                  />
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-note">Nota personal</label>
                  <textarea
                    id="idea-note"
                    class="form-control form-control--textarea"
                    rows="2"
                    placeholder="Detalles para recordar, materiales, combinaciones…"
                  ></textarea>
                </div>

                <button class="button form-submit" type="submit">Guardar idea</button>
              </form>

              <div class="ideas-toolbar">
                <div class="ideas-filter">
                  <label class="form-label" for="idea-search">Buscar</label>
                  <input
                    id="idea-search"
                    class="form-control"
                    type="search"
                    placeholder="Buscar por título o nota"
                  />
                </div>
              </div>

              <div id="ideas-grid" class="ideas-grid" aria-live="polite"></div>
            </div>
          </section>

          <section id="lugares" class="tab-content" role="tabpanel" aria-labelledby="lugares-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Lugares</h2>
                <p class="panel__subtitle">
                  Compara espacios, agenda visitas y elige el sitio ideal para la boda.
                </p>
              </header>

              <form id="venue-form" class="form-grid venues-form" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="venue-name">Nombre</label>
                  <input
                    id="venue-name"
                    class="form-control"
                    type="text"
                    placeholder="Nombre del lugar"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-address">Dirección</label>
                  <input
                    id="venue-address"
                    class="form-control"
                    type="text"
                    placeholder="Calle, ciudad"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-maps">Página Web</label>
                  <input
                    id="venue-maps"
                    class="form-control"
                    type="url"
                    placeholder="https://google.com/..."
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-capacity">Capacidad</label>
                  <input
                    id="venue-capacity"
                    class="form-control"
                    type="number"
                    min="0"
                    step="1"
                    inputmode="numeric"
                    placeholder="Personas"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-price">Precio estimado</label>
                  <input
                    id="venue-price"
                    class="form-control"
                    type="number"
                    min="0"
                    step="1"
                    inputmode="numeric"
                    placeholder="€"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-date">Fecha disponible</label>
                  <input id="venue-date" class="form-control" type="date" />
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-contact">Contacto</label>
                  <input
                    id="venue-contact"
                    class="form-control"
                    type="text"
                    placeholder="Persona, teléfono o email"
                  />
                </div>

                <div class="form-field form-field--full venues-form__proscons">
                  <div class="venues-form__column">
                    <label class="form-label" for="venue-pros">Pros</label>
                    <textarea
                      id="venue-pros"
                      class="form-control form-control--textarea"
                      rows="2"
                      placeholder="Puntos fuertes del lugar"
                    ></textarea>
                  </div>

                  <div class="venues-form__column">
                    <label class="form-label" for="venue-cons">Contras</label>
                    <textarea
                      id="venue-cons"
                      class="form-control form-control--textarea"
                      rows="2"
                      placeholder="Aspectos a mejorar o dudas"
                    ></textarea>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-label" for="venue-status">Estado</label>
                  <select id="venue-status" class="form-control">
                    <option value="pendiente">Pendiente</option>
                    <option value="visitado">Visitado</option>
                    <option value="favorito">Favorito</option>
                    <option value="descartado">Descartado</option>
                  </select>
                </div>

                <button class="button form-submit" type="submit">Agregar lugar</button>
              </form>

              <div class="venues-summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Lugares</span>
                  <strong id="venue-total" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Favoritos</span>
                  <strong id="venue-favorites" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Pendientes</span>
                  <strong id="venue-pending" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Precio medio</span>
                  <strong id="venue-price-avg" class="summary__value">—</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Precio mediano</span>
                  <strong id="venue-price-median" class="summary__value">—</strong>
                </div>
              </div>

              <div class="venues-toolbar">
                <div class="venues-filter">
                  <label class="form-label" for="venue-status-filter">Estado</label>
                  <select id="venue-status-filter" class="form-control">
                    <option value="todas">Todos</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="visitado">Visitado</option>
                    <option value="favorito">Favorito</option>
                    <option value="descartado">Descartado</option>
                  </select>
                </div>

                <div class="venues-filter venues-filter--range">
                  <label class="form-label" for="venue-capacity-min">Capacidad (min–max)</label>
                  <div class="venues-filter__range-inputs">
                    <input
                      id="venue-capacity-min"
                      class="form-control"
                      type="number"
                      min="0"
                      step="1"
                      inputmode="numeric"
                      placeholder="Mín"
                    />
                    <input
                      id="venue-capacity-max"
                      class="form-control"
                      type="number"
                      min="0"
                      step="1"
                      inputmode="numeric"
                      placeholder="Máx"
                    />
                  </div>
                </div>

                <div class="venues-filter">
                  <label class="form-label" for="venue-sort">Ordenar</label>
                  <select id="venue-sort" class="form-control">
                    <option value="recent">Más recientes</option>
                    <option value="price-asc">Precio ascendente</option>
                    <option value="price-desc">Precio descendente</option>
                    <option value="capacity-asc">Capacidad ascendente</option>
                    <option value="capacity-desc">Capacidad descendente</option>
                  </select>
                </div>

                <div class="venues-filter venues-filter--search">
                  <label class="form-label" for="venue-search">Buscar</label>
                  <input
                    id="venue-search"
                    class="form-control"
                    type="search"
                    placeholder="Nombre o dirección"
                  />
                </div>

                <div class="venues-view" role="group" aria-label="Cambiar vista de lugares">
                  <button
                    id="venue-view-cards"
                    class="button button--ghost venues-view__button is-active"
                    type="button"
                    data-view="cards"
                  >
                    Tarjetas
                  </button>
                  <button
                    id="venue-view-table"
                    class="button button--ghost venues-view__button"
                    type="button"
                    data-view="table"
                  >
                    Tabla
                  </button>
                </div>

                <button id="venue-export" class="button button--ghost venues-export" type="button">
                  Exportar CSV
                </button>
              </div>

              <div class="venues-content">
                <div id="venues-grid" class="venues-grid" aria-live="polite"></div>

                <div id="venues-table" class="venues-table" hidden>
                  <table class="venues-table__inner">
                    <thead>
                      <tr>
                        <th scope="col">Nombre</th>
                        <th scope="col">Capacidad</th>
                        <th scope="col">Precio</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Fecha</th>
                        <th scope="col">Pros</th>
                        <th scope="col">Contras</th>
                        <th scope="col">Contacto</th>
                        <th scope="col">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="venues-table-body"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <section id="invitados" class="tab-content" role="tabpanel" aria-labelledby="invitados-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Invitados</h2>
                <p class="panel__subtitle">
                  Gestiona confirmaciones, acompañantes y notas especiales en tiempo real.
                </p>
              </header>

              <div class="guest-tabs" id="guest-tabs" role="tablist" aria-label="Vistas de invitados">
                <button
                  id="guest-main-tab"
                  class="guest-tabs__tab is-active"
                  type="button"
                  data-target="guest-main-panel"
                  aria-controls="guest-main-panel"
                  aria-selected="true"
                >
                  Lista principal
                </button>
                <button
                  id="guest-rsvps-tab"
                  class="guest-tabs__tab"
                  type="button"
                  data-target="guest-rsvp-panel"
                  aria-controls="guest-rsvp-panel"
                  aria-selected="false"
                >
                  RSVPs
                </button>
              </div>

              <div
                id="guest-main-panel"
                class="guest-tab-panel is-active"
                role="tabpanel"
                aria-labelledby="guest-main-tab"
              >
                <form id="guest-form" class="form-grid" autocomplete="off">
                  <div class="form-field form-field--full">
                    <label class="form-label" for="guest-name">Nombre</label>
                    <input
                      id="guest-name"
                      class="form-control"
                      type="text"
                      placeholder="Nombre completo"
                      required
                    />
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-side">Lado</label>
                    <select id="guest-side" class="form-control" required>
                      <option value="novia">Novia</option>
                      <option value="novio">Novio</option>
                      <option value="ambos">Ambos</option>
                    </select>
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-group">Grupo</label>
                    <input
                      id="guest-group"
                      class="form-control"
                      type="text"
                      placeholder="Familia, amigos…"
                    />
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-room">Habitación</label>
                    <input
                      id="guest-room"
                      class="form-control"
                      type="text"
                      placeholder="Ej. Suite 1, Habitación 202"
                      list="guest-room-options"
                    />
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-rsvp">RSVP</label>
                    <select id="guest-rsvp" class="form-control">
                      <option value="pending">Pendiente</option>
                      <option value="yes">Confirmado</option>
                      <option value="no">Rechazado</option>
                    </select>
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-plus">Acompañantes</label>
                    <input
                      id="guest-plus"
                      class="form-control"
                      type="number"
                      min="0"
                      step="1"
                      value="0"
                    />
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-contact">Contacto</label>
                    <input
                      id="guest-contact"
                      class="form-control"
                      type="text"
                      placeholder="Correo o teléfono"
                    />
                  </div>

                  <div class="form-field">
                    <label class="form-label" for="guest-dietary">Restricciones</label>
                    <input
                      id="guest-dietary"
                      class="form-control"
                      type="text"
                      placeholder="Sin gluten, vegetariano…"
                    />
                  </div>

                  <div class="form-field form-field--full">
                    <label class="form-label" for="guest-notes">Notas</label>
                    <textarea
                      id="guest-notes"
                      class="form-control form-control--textarea"
                      rows="2"
                      placeholder="Comentarios extra"
                    ></textarea>
                  </div>

                  <button class="button form-submit" type="submit">Agregar invitado</button>
                </form>

                <div class="guest-summary" aria-live="polite">
                  <div class="summary__item">
                    <span class="summary__label">Invitados</span>
                    <strong id="guest-total" class="summary__value">0</strong>
                  </div>
                  <div class="summary__item">
                    <span class="summary__label">Confirmados</span>
                    <strong id="guest-confirmed" class="summary__value">0</strong>
                  </div>
                  <div class="summary__item">
                    <span class="summary__label">Pendientes</span>
                    <strong id="guest-pending" class="summary__value">0</strong>
                  </div>
                  <div class="summary__item">
                    <span class="summary__label">Personas totales</span>
                    <strong id="guest-people" class="summary__value">0</strong>
                  </div>
                </div>

                <div class="guest-toolbar">
                  <div class="guest-filter">
                    <label class="form-label" for="guest-search">Buscar</label>
                    <input
                      id="guest-search"
                      class="form-control"
                      type="search"
                      placeholder="Buscar por nombre"
                    />
                  </div>
                  <div class="guest-filter">
                    <label class="form-label" for="guest-rsvp-filter">RSVP</label>
                    <select id="guest-rsvp-filter" class="form-control">
                      <option value="">Todos</option>
                      <option value="yes">Confirmados</option>
                      <option value="pending">Pendientes</option>
                      <option value="no">Rechazados</option>
                    </select>
                  </div>
                  <div class="guest-filter">
                    <label class="form-label" for="guest-group-filter">Grupo</label>
                    <select id="guest-group-filter" class="form-control">
                      <option value="">Todos</option>
                    </select>
                  </div>
                  <div class="guest-filter">
                    <label class="form-label" for="guest-room-filter">Habitación</label>
                    <select id="guest-room-filter" class="form-control">
                      <option value="">Todas</option>
                      <option value="__unassigned">Sin asignar</option>
                    </select>
                  </div>
                  <button id="guest-export" class="button button--ghost" type="button">
                    Exportar CSV
                  </button>
                </div>

                <datalist id="guest-room-options"></datalist>

                <ul id="guest-list" class="guest-list" aria-live="polite"></ul>

                <section id="guest-rooms" class="guest-rooms" aria-live="polite" hidden>
                  <header class="guest-rooms__header">
                    <h3 class="guest-rooms__title">Distribución por habitaciones</h3>
                    <p class="guest-rooms__subtitle">
                      Consulta quién comparte cada habitación y el total de personas asignadas.
                    </p>
                  </header>
                  <div id="guest-rooms-grid" class="guest-rooms__grid"></div>
                </section>
              </div>

              <div
                id="guest-rsvp-panel"
                class="guest-tab-panel"
                role="tabpanel"
                aria-labelledby="guest-rsvps-tab"
                hidden
              >
                <section class="guest-rsvp">
                  <header class="guest-rsvp__header">
                    <h3 class="guest-rsvp__title">Confirmaciones recibidas</h3>
                    <p class="guest-rsvp__subtitle">
                      Consulta las respuestas del formulario RSVP y agrégalas a la lista principal en un clic.
                    </p>
                  </header>

                  <p id="guest-rsvp-empty" class="guest-rsvp__empty" aria-live="polite">
                    Todavía no hay confirmaciones registradas.
                  </p>

                  <div
                    id="guest-rsvp-table-wrapper"
                    class="table-wrapper guest-rsvp__table-wrapper"
                    hidden
                  >
                    <table class="guest-rsvp__table" aria-describedby="guest-rsvp-empty">
                      <thead>
                        <tr>
                          <th scope="col">Nombre</th>
                          <th scope="col">Nº Personas</th>
                          <th scope="col">¿Asiste?</th>
                          <th scope="col">Fecha de respuesta</th>
                        </tr>
                      </thead>
                      <tbody id="guest-rsvp-table-body"></tbody>
                    </table>
                  </div>

                  <div id="guest-rsvp-selection" class="guest-rsvp__selection" hidden>
                    <p id="guest-rsvp-selection-text" class="guest-rsvp__selection-text"></p>
                    <p
                      id="guest-rsvp-selection-notice"
                      class="guest-rsvp__notice"
                      aria-live="polite"
                      hidden
                    ></p>
                    <button id="guest-rsvp-add" class="button" type="button">
                      Añadir a lista de invitados
                    </button>
                  </div>
                </section>
              </div>
            </div>
          </section>

          <section id="presupuesto" class="tab-content" role="tabpanel" aria-labelledby="presupuesto-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Presupuesto</h2>
                <p class="panel__subtitle">
                  Define tu objetivo, sigue gastos estimados y reales y controla pagos.
                </p>
              </header>

              <form id="budget-target-form" class="budget-target" autocomplete="off">
                <label class="form-label" for="budget-target">Objetivo general</label>
                <div class="budget-target__controls">
                  <input
                    id="budget-target"
                    class="form-control"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0"
                  />
                  <button class="button button--compact" type="submit">Guardar objetivo</button>
                </div>
              </form>

              <div class="budget-summary" aria-live="polite">
                <div class="budget-summary__item">
                  <span class="summary__label">Objetivo</span>
                  <strong id="budget-target-value" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Estimado sin real</span>
                  <strong id="budget-estimated" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Real</span>
                  <strong id="budget-actual" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Total</span>
                  <strong id="budget-total" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">% Pagado</span>
                  <strong id="budget-paid-percent" class="summary__value">0%</strong>
                </div>
              </div>

              <form id="budget-item-form" class="form-grid budget-item-form" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="budget-title">Concepto</label>
                  <input
                    id="budget-title"
                    class="form-control"
                    type="text"
                    placeholder="Catering, música, flores…"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-category">Categoría</label>
                  <input
                    id="budget-category"
                    class="form-control"
                    type="text"
                    placeholder="Catering, foto…"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-estimate">Estimado</label>
                  <input
                    id="budget-estimate"
                    class="form-control"
                    type="number"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-actual-input">Real</label>
                  <input
                    id="budget-actual-input"
                    class="form-control"
                    type="number"
                    min="0"
                    step="0.01"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-provider">Proveedor</label>
                  <input
                    id="budget-provider"
                    class="form-control"
                    type="text"
                    placeholder="Nombre o contacto"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-date">Fecha</label>
                  <input id="budget-date" class="form-control" type="date" />
                </div>

                <button class="button form-submit" type="submit">Agregar gasto</button>
              </form>

              <div class="budget-toolbar">
                <div class="budget-filter">
                  <label class="form-label" for="budget-category-filter">Categoría</label>
                  <select id="budget-category-filter" class="form-control">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="budget-filter">
                  <label class="form-label" for="budget-paid-filter">Pagado</label>
                  <select id="budget-paid-filter" class="form-control">
                    <option value="">Todos</option>
                    <option value="paid">Pagados</option>
                    <option value="pending">Pendientes</option>
                  </select>
                </div>
              </div>

              <div class="table-wrapper">
                <table class="budget-table" aria-describedby="presupuesto-tab">
                  <thead>
                    <tr>
                      <th scope="col">Concepto</th>
                      <th scope="col">Categoría</th>
                      <th scope="col">Estimado</th>
                      <th scope="col">Real</th>
                      <th scope="col">Final</th>
                      <th scope="col">Pagado</th>
                      <th scope="col">Fecha</th>
                      <th scope="col" class="visually-hidden">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="budget-table-body"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="viaje" class="tab-content" role="tabpanel" aria-labelledby="viaje-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Viaje</h2>
                <p class="panel__subtitle">
                  Plantea destinos, compara pros y contras y estima los costes del viaje de novios.
                </p>
              </header>

              <form id="trip-form" class="form-grid trip-form" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="trip-destination">Destino</label>
                  <input
                    id="trip-destination"
                    class="form-control"
                    type="text"
                    placeholder="Japón, Riviera Maya..."
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="trip-travel-mode">Forma de viajar</label>
                  <select id="trip-travel-mode" class="form-control">
                    <option value="avion" selected>Avión</option>
                    <option value="tren">Tren</option>
                    <option value="coche">Coche</option>
                    <option value="crucero">Crucero</option>
                    <option value="mixto">Mixto</option>
                  </select>
                </div>

                <div class="form-field">
                  <label class="form-label" for="trip-price">Presupuesto estimado</label>
                  <input
                    id="trip-price"
                    class="form-control"
                    type="number"
                    min="0"
                    step="1"
                    inputmode="numeric"
                    placeholder="€"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="trip-status">Estado</label>
                  <select id="trip-status" class="form-control">
                    <option value="candidato" selected>Candidato</option>
                    <option value="favorito">Favorito</option>
                    <option value="descartado">Descartado</option>
                  </select>
                </div>

                <div class="form-field form-field--full trip-form__proscons">
                  <div class="trip-form__column">
                    <label class="form-label" for="trip-pros">Pros</label>
                    <textarea
                      id="trip-pros"
                      class="form-control form-control--textarea"
                      rows="2"
                      placeholder="Una ventaja por línea"
                    ></textarea>
                  </div>

                  <div class="trip-form__column">
                    <label class="form-label" for="trip-cons">Contras</label>
                    <textarea
                      id="trip-cons"
                      class="form-control form-control--textarea"
                      rows="2"
                      placeholder="Un punto a considerar por línea"
                    ></textarea>
                  </div>
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="trip-notes">Notas adicionales</label>
                  <textarea
                    id="trip-notes"
                    class="form-control form-control--textarea"
                    rows="2"
                    placeholder="Excursiones pendientes, vuelos a vigilar..."
                  ></textarea>
                </div>

                <button class="button form-submit" type="submit">Agregar destino</button>
              </form>

              <div class="trips-summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Destinos</span>
                  <strong id="trip-total" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Favoritos</span>
                  <strong id="trip-favorites" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Presupuesto medio</span>
                  <strong id="trip-price-avg" class="summary__value">—</strong>
                </div>
              </div>

              <div class="trips-toolbar">
                <div class="trips-filter">
                  <label class="form-label" for="trip-status-filter">Estado</label>
                  <select id="trip-status-filter" class="form-control">
                    <option value="todas">Todos</option>
                    <option value="candidato">Candidatos</option>
                    <option value="favorito">Favoritos</option>
                    <option value="descartado">Descartados</option>
                  </select>
                </div>
                <div class="trips-filter">
                  <label class="form-label" for="trip-sort">Ordenar</label>
                  <select id="trip-sort" class="form-control">
                    <option value="recent" selected>Más recientes</option>
                    <option value="price-asc">Precio ascendente</option>
                    <option value="price-desc">Precio descendente</option>
                  </select>
                </div>
                <div class="trips-filter trips-filter--search">
                  <label class="form-label" for="trip-search">Buscar</label>
                  <input
                    id="trip-search"
                    class="form-control"
                    type="search"
                    placeholder="Buscar por destino"
                  />
                </div>
              </div>

              <div id="trips-grid" class="trips-grid" aria-live="polite"></div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script>
      // ⚠️ Rellena con TUS credenciales reales. MUY IMPORTANTE: añade también databaseURL.
      // - databaseURL: cópiala desde Firebase → Realtime Database → pestaña "Data".
      // - storageBucket debe acabar en .appspot.com
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyCKHtBq_JjgYSy-lpnpka8jNpaW4GbMefU",
        authDomain: "boda-f0cac.firebaseapp.com",
        databaseURL: "https://boda-f0cac-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "boda-f0cac",
        storageBucket: "boda-f0cac.appspot.com",
        messagingSenderId: "764003731377",
        appId: "1:764003731377:web:5dccc6fa01c0409121df90",
        // measurementId opcional
      };

      // Encendido / apagado de la sync remota sin tocar más código
      window.ENABLE_SYNC = true;

      // Sala compartida entre vosotros
      window.DEFAULT_ROOM_ID = "andrea-boda";
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        push,
        update,
        remove,
        onValue,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      const firebaseConfig = window.FIREBASE_CONFIG;
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const ROOM = window.DEFAULT_ROOM_ID || "andrea-boda";
      const tasksPath = `rooms/${ROOM}/tasks`;
      const guestsPath = `rooms/${ROOM}/guests`;
      const rsvpSubmissionsPath = `rooms/${ROOM}/rsvp_submissions`;
      const venuesPath = `rooms/${ROOM}/venues`;
      const ideasPath = `rooms/${ROOM}/ideas`;
      const timelinePath = `rooms/${ROOM}/timeline`;
      const budgetPath = `rooms/${ROOM}/budget`;
      const budgetMetaPath = `${budgetPath}/meta`;
      const budgetItemsPath = `${budgetPath}/items`;

      const TASK_PRIORITY_VALUES = new Set(["alta", "media", "baja"]);

      function ensureSync() {
        if (!window.ENABLE_SYNC) {
          throw new Error("SYNC_OFF");
        }
      }

      let resolveAuthReady;
      let rejectAuthReady;
      const authReadyPromise = new Promise((resolve, reject) => {
        resolveAuthReady = resolve;
        rejectAuthReady = reject;
      });

      signInAnonymously(auth).catch((error) => {
        console.error("Error al iniciar sesión de forma anónima.", error);

        if (typeof rejectAuthReady === "function") {
          rejectAuthReady(error);
          resolveAuthReady = null;
          rejectAuthReady = null;
        }
      });

      onAuthStateChanged(
        auth,
        (user) => {
          if (user && user.uid) {
            console.debug("Firebase Auth listo. UID:", user.uid);

            if (typeof resolveAuthReady === "function") {
              resolveAuthReady(user);
              resolveAuthReady = null;
              rejectAuthReady = null;
            }
          }
        },
        (error) => {
          console.error("Error al observar el estado de autenticación.", error);

          if (typeof rejectAuthReady === "function") {
            rejectAuthReady(error);
            resolveAuthReady = null;
            rejectAuthReady = null;
          }
        },
      );

      const waitForAuth = () => authReadyPromise;

      export function listenTasks(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const tasksRef = ref(db, tasksPath);
            unsubscribe = onValue(
              tasksRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en las tareas de Firebase.", error);
              },
            );
          })
          .catch((error) => {
            console.error(
              "No se pudo iniciar la escucha de tareas porque la autenticación falló.",
              error,
            );
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export function listenMilestones(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const timelineRef = ref(db, timelinePath);
            unsubscribe = onValue(
              timelineRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en los hitos de Firebase.", error);
              },
            );
          })
          .catch((error) => {
            console.error(
              "No se pudo iniciar la escucha de hitos porque la autenticación falló.",
              error,
            );
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addTask(task) {
        await waitForAuth();
        ensureSync();

        const tasksRef = ref(db, tasksPath);
        const payload = {
          description: String(task.description ?? "").trim(),
          category: task.category ?? "otro",
          priority: task.priority ?? "media",
          dueDate: task.dueDate ?? "",
          completed: Boolean(task.completed),
          createdAt:
            typeof task.createdAt === "number" && Number.isFinite(task.createdAt)
              ? task.createdAt
              : Date.now(),
          updatedAt:
            typeof task.updatedAt === "number" && Number.isFinite(task.updatedAt)
              ? task.updatedAt
              : Date.now(),
          id: typeof task.id === "string" && task.id ? task.id : null,
        };

        try {
          await push(tasksRef, payload);
        } catch (error) {
          console.error("No se pudo crear la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function toggleTask(taskId, completed) {
        await waitForAuth();
        ensureSync();

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await update(taskRef, {
            completed: Boolean(completed),
            updatedAt: Date.now(),
          });
        } catch (error) {
          console.error("No se pudo actualizar la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function updateTask(taskId, changes) {
        await waitForAuth();
        ensureSync();

        if (!taskId) {
          throw new Error("ID de tarea inválido");
        }

        const sanitized = {};

        if (changes && typeof changes === "object") {
          if (Object.prototype.hasOwnProperty.call(changes, "priority")) {
            const rawPriority = typeof changes.priority === "string" ? changes.priority.trim() : "";

            if (TASK_PRIORITY_VALUES.has(rawPriority)) {
              sanitized.priority = rawPriority;
            }
          }

          if (Object.prototype.hasOwnProperty.call(changes, "completed")) {
            sanitized.completed = Boolean(changes.completed);
          }

          if (Object.prototype.hasOwnProperty.call(changes, "updatedAt")) {
            const timestamp = changes.updatedAt;

            if (typeof timestamp === "number" && Number.isFinite(timestamp)) {
              sanitized.updatedAt = timestamp;
            }
          }
        }

        if (!Object.keys(sanitized).length) {
          return;
        }

        if (!Object.prototype.hasOwnProperty.call(sanitized, "updatedAt")) {
          sanitized.updatedAt = Date.now();
        }

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await update(taskRef, sanitized);
        } catch (error) {
          console.error("No se pudo actualizar la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function deleteTask(taskId) {
        await waitForAuth();
        ensureSync();

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await remove(taskRef);
        } catch (error) {
          console.error("No se pudo eliminar la tarea en Firebase.", error);
          throw error;
        }
      }

      const RSVP_VALUES = new Set(["pending", "yes", "no"]);
      const SIDE_VALUES = new Set(["novia", "novio", "ambos"]);

      const sanitizeText = (value) =>
        typeof value === "string" ? value.trim() : typeof value === "number" ? String(value).trim() : "";

      const sanitizeIdeaImage = (value) => {
        if (typeof value !== "string") {
          return "";
        }

        const trimmed = value.trim();

        if (!trimmed) {
          return "";
        }

        if (trimmed.startsWith("data:image/")) {
          return trimmed;
        }

        if (typeof URL === "function") {
          try {
            const parsed = new URL(trimmed);

            if (parsed.protocol === "http:" || parsed.protocol === "https:") {
              return trimmed;
            }
          } catch (error) {
            // Ignorar valores que no sean URLs válidas.
          }
        }

        return "";
      };

      const normalizePlusOnes = (value) => {
        if (typeof value === "number" && Number.isFinite(value)) {
          return Math.max(0, Math.trunc(value));
        }

        if (typeof value === "string") {
          const parsed = Number.parseInt(value, 10);
          if (Number.isFinite(parsed)) {
            return Math.max(0, parsed);
          }
        }

        return 0;
      };

      const normalizeRsvp = (value) => (RSVP_VALUES.has(value) ? value : "pending");

      const normalizeSide = (value) => (SIDE_VALUES.has(value) ? value : "ambos");

      const toTimestampValue = (value, fallback) =>
        typeof value === "number" && Number.isFinite(value) ? value : fallback;

      const MILESTONE_STATUS_VALUES = new Set(["planned", "in-progress", "done"]);
      const MILESTONE_REMINDER_VALUES = new Set(["none", "1w", "3d", "1d"]);

      const sanitizeMilestoneStatus = (value) =>
        MILESTONE_STATUS_VALUES.has(value) ? value : "planned";

      const sanitizeMilestoneReminder = (value) =>
        MILESTONE_REMINDER_VALUES.has(value) ? value : "none";

      const normalizeMilestoneResponsibles = (value) => {
        if (Array.isArray(value)) {
          return value.map((item) => sanitizeText(item)).filter((item) => Boolean(item));
        }

        if (typeof value !== "string") {
          return [];
        }

        return value
          .split(",")
          .map((item) => sanitizeText(item))
          .filter((item) => Boolean(item));
      };

      export async function addMilestone(milestone) {
        await waitForAuth();
        ensureSync();

        const timelineRef = ref(db, timelinePath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const title = sanitizeText(milestone?.title);

        if (!title) {
          throw new Error("TITLE_REQUIRED");
        }

        const payload = {
          title,
          date: sanitizeText(milestone?.date),
          status: sanitizeMilestoneStatus(milestone?.status),
          responsibles: normalizeMilestoneResponsibles(milestone?.responsibles),
          reminder: sanitizeMilestoneReminder(milestone?.reminder),
          notes: sanitizeText(milestone?.notes),
          createdAt: toTimestampValue(milestone?.createdAt, now),
          updatedAt: toTimestampValue(milestone?.updatedAt, now),
          createdBy:
            sanitizeText(milestone?.createdBy) ||
            (currentUser && currentUser.uid ? currentUser.uid : null),
          id: typeof milestone?.id === "string" && milestone.id ? milestone.id : null,
        };

        try {
          await push(timelineRef, payload);
        } catch (error) {
          console.error("No se pudo crear el hito en Firebase.", error);
          throw error;
        }
      }

      export async function updateMilestone(milestoneId, changes) {
        await waitForAuth();
        ensureSync();

        const milestoneRef = ref(db, `${timelinePath}/${milestoneId}`);
        const payload = { updatedAt: Date.now() };

        if (typeof changes?.title === "string") {
          const trimmed = sanitizeText(changes.title);
          if (trimmed) {
            payload.title = trimmed;
          }
        }

        if (typeof changes?.date === "string") {
          payload.date = sanitizeText(changes.date);
        }

        if (typeof changes?.status === "string") {
          payload.status = sanitizeMilestoneStatus(changes.status);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "responsibles")) {
          payload.responsibles = normalizeMilestoneResponsibles(changes.responsibles);
        }

        if (typeof changes?.reminder === "string") {
          payload.reminder = sanitizeMilestoneReminder(changes.reminder);
        }

        if (typeof changes?.notes === "string") {
          payload.notes = sanitizeText(changes.notes);
        }

        try {
          await update(milestoneRef, payload);
        } catch (error) {
          console.error("No se pudo actualizar el hito en Firebase.", error);
          throw error;
        }
      }

      export async function deleteMilestone(milestoneId) {
        await waitForAuth();
        ensureSync();

        const milestoneRef = ref(db, `${timelinePath}/${milestoneId}`);

        try {
          await remove(milestoneRef);
        } catch (error) {
          console.error("No se pudo eliminar el hito en Firebase.", error);
          throw error;
        }
      }

      export function listenGuests(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const guestsRef = ref(db, guestsPath);
            unsubscribe = onValue(
              guestsRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en invitados.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de invitados.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export function listenRsvpSubmissions(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const rsvpRef = ref(db, rsvpSubmissionsPath);
            unsubscribe = onValue(
              rsvpRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en RSVPs.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de RSVPs.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addGuest(guest) {
        await waitForAuth();
        ensureSync();

        const guestsRef = ref(db, guestsPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const name = sanitizeText(guest?.name);

        if (!name) {
          throw new Error("NAME_REQUIRED");
        }

        const payload = {
          name,
          side: normalizeSide(guest?.side),
          group: sanitizeText(guest?.group),
          room: sanitizeText(guest?.room),
          rsvp: normalizeRsvp(guest?.rsvp),
          plusOnes: normalizePlusOnes(guest?.plusOnes),
          dietary: sanitizeText(guest?.dietary),
          notes: sanitizeText(guest?.notes),
          contact: sanitizeText(guest?.contact),
          createdAt: toTimestampValue(guest?.createdAt, now),
          updatedAt: toTimestampValue(guest?.updatedAt, now),
          createdBy:
            sanitizeText(guest?.createdBy) || (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        try {
          await push(guestsRef, payload);
        } catch (error) {
          console.error("No se pudo crear el invitado en Firebase.", error);
          throw error;
        }
      }

      export async function updateGuest(guestId, changes) {
        await waitForAuth();
        ensureSync();

        const guestRef = ref(db, `${guestsPath}/${guestId}`);
        const updatePayload = {};

        if (typeof changes?.name === "string") {
          const trimmed = changes.name.trim();
          if (trimmed) {
            updatePayload.name = trimmed;
          }
        }

        if (typeof changes?.group === "string") {
          updatePayload.group = changes.group.trim();
        }

        if (typeof changes?.room === "string") {
          updatePayload.room = changes.room.trim();
        }

        if (typeof changes?.contact === "string") {
          updatePayload.contact = changes.contact.trim();
        }

        if (typeof changes?.dietary === "string") {
          updatePayload.dietary = changes.dietary.trim();
        }

        if (typeof changes?.notes === "string") {
          updatePayload.notes = changes.notes.trim();
        }

        if (typeof changes?.side === "string") {
          updatePayload.side = normalizeSide(changes.side);
        }

        if (typeof changes?.rsvp === "string") {
          updatePayload.rsvp = normalizeRsvp(changes.rsvp);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "plusOnes")) {
          updatePayload.plusOnes = normalizePlusOnes(changes.plusOnes);
        }

        updatePayload.updatedAt = Date.now();

        try {
          await update(guestRef, updatePayload);
        } catch (error) {
          console.error("No se pudo actualizar el invitado en Firebase.", error);
          throw error;
        }
      }

      export async function deleteGuest(guestId) {
        await waitForAuth();
        ensureSync();

        const guestRef = ref(db, `${guestsPath}/${guestId}`);

        try {
          await remove(guestRef);
        } catch (error) {
          console.error("No se pudo eliminar el invitado en Firebase.", error);
          throw error;
        }
      }

      const escapeCsvCell = (value) => {
        if (value === null || value === undefined) {
          return "";
        }

        const stringValue = String(value).replace(/[\r\n]+/g, " ").trim();
        if (stringValue === "") {
          return "";
        }

        if (/[",;]/.test(stringValue)) {
          return `"${stringValue.replace(/"/g, '""')}"`;
        }

        return stringValue;
      };

      const formatCsvDate = (timestamp) => {
        if (typeof timestamp !== "number" || !Number.isFinite(timestamp)) {
          return "";
        }

        try {
          return new Date(timestamp).toISOString();
        } catch (error) {
          return "";
        }
      };

      export function exportGuestsCSV(guestsObj) {
        const headers = [
          "ID",
          "Nombre",
          "Lado",
          "Grupo",
          "Habitación",
          "RSVP",
          "Acompañantes",
          "Personas totales",
          "Restricciones",
          "Notas",
          "Contacto",
          "Creado",
          "Actualizado",
          "Creado por",
        ];

        const rows = [headers];

        if (guestsObj && typeof guestsObj === "object") {
          Object.entries(guestsObj).forEach(([id, record]) => {
            if (!record || typeof record !== "object") {
              return;
            }

            const plusOnes = normalizePlusOnes(record.plusOnes);
            const totalPeople = 1 + plusOnes;

            rows.push([
              id,
              sanitizeText(record.name),
              normalizeSide(record.side),
              sanitizeText(record.group),
              sanitizeText(record.room),
              normalizeRsvp(record.rsvp),
              plusOnes,
              totalPeople,
              sanitizeText(record.dietary),
              sanitizeText(record.notes),
              sanitizeText(record.contact),
              formatCsvDate(record.createdAt),
              formatCsvDate(record.updatedAt),
              sanitizeText(record.createdBy),
            ]);
          });
        }

        return rows.map((row) => row.map((cell) => escapeCsvCell(cell)).join(",")).join("\n");
      }

      const VENUE_STATUS_VALUES = new Set([
        "pendiente",
        "visitado",
        "favorito",
        "descartado",
      ]);

      const sanitizeVenueText = (value) =>
        typeof value === "string"
          ? value.trim()
          : typeof value === "number"
          ? String(value).trim()
          : "";

      const normalizeVenueStatus = (value) =>
        VENUE_STATUS_VALUES.has(value) ? value : "pendiente";

      const normalizeVenueCapacity = (value) => {
        if (typeof value === "number" && Number.isFinite(value)) {
          return Math.max(0, Math.trunc(value));
        }

        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) {
            return null;
          }

          const parsed = Number.parseInt(trimmed, 10);
          if (Number.isFinite(parsed)) {
            return Math.max(0, parsed);
          }
        }

        return null;
      };

      const normalizeVenuePrice = (value) => {
        if (typeof value === "number" && Number.isFinite(value)) {
          if (value < 0) {
            return null;
          }
          return Number.parseFloat(value.toFixed(2));
        }

        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) {
            return null;
          }

          const normalized = trimmed.replace(/,/g, ".");
          const parsed = Number.parseFloat(normalized);

          if (Number.isFinite(parsed) && parsed >= 0) {
            return Number.parseFloat(parsed.toFixed(2));
          }
        }

        return null;
      };

      const normalizeVenueDate = (value) => {
        if (typeof value !== "string") {
          return "";
        }

        const trimmed = value.trim();

        if (!trimmed) {
          return "";
        }

        const [yearStr, monthStr, dayStr] = trimmed.split("-");

        if (!yearStr || !monthStr || !dayStr) {
          return "";
        }

        const year = Number.parseInt(yearStr, 10);
        const month = Number.parseInt(monthStr, 10);
        const day = Number.parseInt(dayStr, 10);

        if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) {
          return "";
        }

        const date = new Date(year, month - 1, day);

        if (
          date.getFullYear() !== year ||
          date.getMonth() !== month - 1 ||
          date.getDate() !== day
        ) {
          return "";
        }

        const normalizedMonth = String(month).padStart(2, "0");
        const normalizedDay = String(day).padStart(2, "0");

        return `${String(year).padStart(4, "0")}-${normalizedMonth}-${normalizedDay}`;
      };

      const buildVenueLegacyNotes = (pros, cons, legacy = "") => {
        const legacyValue = sanitizeVenueText(legacy);

        if (legacyValue) {
          return legacyValue;
        }

        const prosValue = sanitizeVenueText(pros);
        const consValue = sanitizeVenueText(cons);
        const parts = [];

        if (prosValue) {
          parts.push(`Pros: ${prosValue}`);
        }

        if (consValue) {
          parts.push(`Contras: ${consValue}`);
        }

        return parts.join(" | ");
      };

      const normalizeVenueMapsUrl = (value) => {
        if (typeof value !== "string") {
          return "";
        }

        const trimmed = value.trim();

        if (!trimmed) {
          return "";
        }

        if (!/^https?:\/\//i.test(trimmed)) {
          return `https://${trimmed}`;
        }

        return trimmed;
      };

      const normalizeVenuePhotos = (value) => {
        if (!Array.isArray(value)) {
          return null;
        }

        const sanitized = value
          .map((item) => (typeof item === "string" ? item.trim() : ""))
          .filter((item) => Boolean(item));

        return sanitized.length ? sanitized : null;
      };

      export function listenVenues(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const venuesRef = ref(db, venuesPath);
            unsubscribe = onValue(
              venuesRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en lugares.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de lugares.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addVenue(venue) {
        await waitForAuth();
        ensureSync();

        const venuesRef = ref(db, venuesPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const name = sanitizeVenueText(venue?.name);

        if (!name) {
          throw new Error("NAME_REQUIRED");
        }

        const pros = sanitizeVenueText(venue?.pros);
        const cons = sanitizeVenueText(venue?.cons);
        const legacyNotes = buildVenueLegacyNotes(pros, cons, venue?.notes);

        const payload = {
          name,
          address: sanitizeVenueText(venue?.address),
          mapsUrl: normalizeVenueMapsUrl(venue?.mapsUrl),
          capacity: normalizeVenueCapacity(venue?.capacity),
          price: normalizeVenuePrice(venue?.price),
          availableDate: normalizeVenueDate(venue?.availableDate),
          contact: sanitizeVenueText(venue?.contact),
          pros,
          cons,
          notes: legacyNotes,
          status: normalizeVenueStatus(venue?.status),
          photos: normalizeVenuePhotos(venue?.photos),
          createdAt: toTimestampValue(venue?.createdAt, now),
          updatedAt: toTimestampValue(venue?.updatedAt, now),
          createdBy:
            sanitizeVenueText(venue?.createdBy) ||
            (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        if (!payload.address) {
          payload.address = "";
        }

        if (!payload.mapsUrl) {
          payload.mapsUrl = "";
        }

        if (!payload.contact) {
          payload.contact = "";
        }

        if (!payload.pros) {
          payload.pros = "";
        }

        if (!payload.cons) {
          payload.cons = "";
        }

        if (!payload.notes) {
          payload.notes = "";
        }

        if (!payload.photos) {
          payload.photos = null;
        }

        try {
          await push(venuesRef, payload);
        } catch (error) {
          console.error("No se pudo crear el lugar en Firebase.", error);
          throw error;
        }
      }

      export async function updateVenue(venueId, changes) {
        await waitForAuth();
        ensureSync();

        const venueRef = ref(db, `${venuesPath}/${venueId}`);
        const updatePayload = { updatedAt: Date.now() };

        if (typeof changes?.name === "string") {
          const trimmed = changes.name.trim();
          if (trimmed) {
            updatePayload.name = trimmed;
          }
        }

        if (typeof changes?.address === "string") {
          updatePayload.address = changes.address.trim();
        }

        if (typeof changes?.mapsUrl === "string") {
          updatePayload.mapsUrl = normalizeVenueMapsUrl(changes.mapsUrl);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "capacity")) {
          updatePayload.capacity = normalizeVenueCapacity(changes.capacity);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "price")) {
          updatePayload.price = normalizeVenuePrice(changes.price);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "availableDate")) {
          updatePayload.availableDate = normalizeVenueDate(changes.availableDate);
        }

        if (typeof changes?.contact === "string") {
          updatePayload.contact = changes.contact.trim();
        }

        if (typeof changes?.pros === "string") {
          updatePayload.pros = sanitizeVenueText(changes.pros);
        }

        if (typeof changes?.cons === "string") {
          updatePayload.cons = sanitizeVenueText(changes.cons);
        }

        if (typeof changes?.notes === "string") {
          updatePayload.notes = sanitizeVenueText(changes.notes);
        }

        if (typeof changes?.status === "string") {
          updatePayload.status = normalizeVenueStatus(changes.status);
        }

        if (Array.isArray(changes?.photos)) {
          updatePayload.photos = normalizeVenuePhotos(changes.photos);
        }

        try {
          await update(venueRef, updatePayload);
        } catch (error) {
          console.error("No se pudo actualizar el lugar en Firebase.", error);
          throw error;
        }
      }

      export async function deleteVenue(venueId) {
        await waitForAuth();
        ensureSync();

        const venueRef = ref(db, `${venuesPath}/${venueId}`);

        try {
          await remove(venueRef);
        } catch (error) {
          console.error("No se pudo eliminar el lugar en Firebase.", error);
          throw error;
        }
      }

      export function exportVenuesCSV(venuesData, appliedFilters = {}) {
        const headers = [
          "ID",
          "Nombre",
          "Dirección",
          "Enlace Maps",
          "Capacidad",
          "Precio",
          "Fecha disponible",
          "Estado",
          "Contacto",
          "Pros",
          "Contras",
          "Notas",
          "Creado",
          "Actualizado",
          "Creado por",
        ];

        const rows = [];

        if (appliedFilters && typeof appliedFilters === "object") {
          const filterParts = [];

          if (appliedFilters.status && appliedFilters.status !== "todas") {
            filterParts.push(`Estado=${appliedFilters.status}`);
          }

          if (appliedFilters.capacityMin !== undefined && appliedFilters.capacityMin !== "") {
            filterParts.push(`Capacidad mínima=${appliedFilters.capacityMin}`);
          }

          if (appliedFilters.capacityMax !== undefined && appliedFilters.capacityMax !== "") {
            filterParts.push(`Capacidad máxima=${appliedFilters.capacityMax}`);
          }

          if (appliedFilters.sort) {
            filterParts.push(`Orden=${appliedFilters.sort}`);
          }

          if (appliedFilters.search) {
            filterParts.push(`Búsqueda=${appliedFilters.search}`);
          }

          if (filterParts.length) {
            rows.push(["Filtros aplicados", filterParts.join(" | ")]);
          }
        }

        rows.push(headers);

        const list = Array.isArray(venuesData)
          ? venuesData
          : Object.entries(venuesData ?? {}).map(([id, record]) => ({ id, ...(record ?? {}) }));

        list.forEach((venue) => {
          const capacityValue = normalizeVenueCapacity(venue.capacity);
          const priceValue = normalizeVenuePrice(venue.price);

          const prosValue = sanitizeVenueText(venue.pros);
          const consValue = sanitizeVenueText(venue.cons);
          const notesValue = buildVenueLegacyNotes(prosValue, consValue, venue.notes);

          rows.push([
            venue.id ?? "",
            sanitizeVenueText(venue.name),
            sanitizeVenueText(venue.address),
            sanitizeVenueText(venue.mapsUrl),
            capacityValue ?? "",
            priceValue ?? "",
            normalizeVenueDate(venue.availableDate),
            normalizeVenueStatus(venue.status),
            sanitizeVenueText(venue.contact),
            prosValue,
            consValue,
            notesValue,
            formatCsvDate(venue.createdAt),
            formatCsvDate(venue.updatedAt),
            sanitizeVenueText(venue.createdBy),
          ]);
        });

        return rows.map((row) => row.map((cell) => escapeCsvCell(cell)).join(",")).join("\n");
      }

      export function listenIdeas(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const ideasRef = ref(db, ideasPath);
            unsubscribe = onValue(
              ideasRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en ideas.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de ideas.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addIdea(idea, uid) {
        await waitForAuth();
        ensureSync();

        const ideasRef = ref(db, ideasPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const title = sanitizeText(idea?.title);

        if (!title) {
          throw new Error("TITLE_REQUIRED");
        }

        const urlValue = sanitizeText(idea?.url);
        const imageValue = sanitizeIdeaImage(idea?.image);

        const payload = {
          title,
          url: urlValue || "",
          image: imageValue || "",
          category: sanitizeText(idea?.category) || "Sin categoría",
          note: sanitizeText(idea?.note),
          likes: idea?.likes && typeof idea.likes === "object" ? idea.likes : {},
          createdAt: toTimestampValue(idea?.createdAt, now),
          updatedAt: toTimestampValue(idea?.updatedAt, now),
          createdBy:
            sanitizeText(idea?.createdBy) || uid || (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        try {
          await push(ideasRef, payload);
        } catch (error) {
          console.error("No se pudo crear la idea en Firebase.", error);
          throw error;
        }
      }

      export async function toggleLike(ideaId, uid, isLiked) {
        await waitForAuth();
        ensureSync();

        if (!ideaId || !uid) {
          throw new Error("LIKE_DATA_MISSING");
        }

        const ideaRef = ref(db, `${ideasPath}/${ideaId}`);
        const updates = { updatedAt: Date.now() };

        updates[`likes/${uid}`] = isLiked ? null : true;

        try {
          await update(ideaRef, updates);
        } catch (error) {
          console.error("No se pudo actualizar el like en Firebase.", error);
          throw error;
        }
      }

      export async function deleteIdea(ideaId) {
        await waitForAuth();
        ensureSync();

        const ideaRef = ref(db, `${ideasPath}/${ideaId}`);

        try {
          await remove(ideaRef);
        } catch (error) {
          console.error("No se pudo eliminar la idea en Firebase.", error);
          throw error;
        }
      }

      export function listenBudget(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const budgetRef = ref(db, budgetPath);
            unsubscribe = onValue(
              budgetRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                const meta = value.meta ?? {};
                const items = value.items ?? {};
                callback({ meta, items });
              },
              (error) => {
                console.error("Error al escuchar cambios en presupuesto.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de presupuesto.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      const normalizeAmount = (value) => {
        if (value === null || typeof value === "undefined") {
          return null;
        }

        if (typeof value === "number" && Number.isFinite(value)) {
          return Math.max(0, Number.parseFloat(value.toFixed(2)));
        }

        if (typeof value === "string") {
          const trimmed = value.trim();

          if (!trimmed) {
            return null;
          }

          const cleaned = trimmed.replace(/,/g, ".");
          const parsed = Number.parseFloat(cleaned);

          if (Number.isFinite(parsed)) {
            return Math.max(0, Number.parseFloat(parsed.toFixed(2)));
          }

          return null;
        }

        return null;
      };

      export async function setBudgetTarget(target) {
        await waitForAuth();
        ensureSync();

        const value = normalizeAmount(target);
        const payload = { target: typeof value === "number" ? value : 0, updatedAt: Date.now() };

        try {
          await update(ref(db, budgetMetaPath), payload);
        } catch (error) {
          console.error("No se pudo actualizar el objetivo de presupuesto en Firebase.", error);
          throw error;
        }
      }

      export async function addBudgetItem(item) {
        await waitForAuth();
        ensureSync();

        const itemsRef = ref(db, budgetItemsPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const title = sanitizeText(item?.title);

        if (!title) {
          throw new Error("TITLE_REQUIRED");
        }

        const estimated = normalizeAmount(item?.est);
        const actual = normalizeAmount(item?.act);

        const payload = {
          title,
          category: sanitizeText(item?.category) || "General",
          est: typeof estimated === "number" ? estimated : 0,
          act: actual,
          paid: Boolean(item?.paid),
          dueDate: sanitizeText(item?.dueDate),
          provider: sanitizeText(item?.provider),
          createdAt: toTimestampValue(item?.createdAt, now),
          updatedAt: toTimestampValue(item?.updatedAt, now),
          createdBy:
            sanitizeText(item?.createdBy) || (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        try {
          await push(itemsRef, payload);
        } catch (error) {
          console.error("No se pudo crear el gasto en Firebase.", error);
          throw error;
        }
      }

      export async function updateBudgetItem(itemId, changes) {
        await waitForAuth();
        ensureSync();

        const itemRef = ref(db, `${budgetItemsPath}/${itemId}`);
        const payload = { updatedAt: Date.now() };

        if (typeof changes?.title === "string" && changes.title.trim()) {
          payload.title = changes.title.trim();
        }

        if (typeof changes?.category === "string") {
          payload.category = changes.category.trim();
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "est")) {
          const estimated = normalizeAmount(changes.est);
          payload.est = typeof estimated === "number" ? estimated : null;
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "act")) {
          payload.act = normalizeAmount(changes.act);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "paid")) {
          payload.paid = Boolean(changes.paid);
        }

        if (typeof changes?.dueDate === "string") {
          payload.dueDate = changes.dueDate.trim();
        }

        if (typeof changes?.provider === "string") {
          payload.provider = changes.provider.trim();
        }

        try {
          await update(itemRef, payload);
        } catch (error) {
          console.error("No se pudo actualizar el gasto en Firebase.", error);
          throw error;
        }
      }

      export async function deleteBudgetItem(itemId) {
        await waitForAuth();
        ensureSync();

        const itemRef = ref(db, `${budgetItemsPath}/${itemId}`);

        try {
          await remove(itemRef);
        } catch (error) {
          console.error("No se pudo eliminar el gasto en Firebase.", error);
          throw error;
        }
      }

      window.FirebaseSync = {
        listenTasks,
        addTask,
        toggleTask,
        updateTask,
        deleteTask,
        listenMilestones,
        addMilestone,
        updateMilestone,
        deleteMilestone,
        listenGuests,
        listenRsvpSubmissions,
        addGuest,
        updateGuest,
        deleteGuest,
        exportGuestsCSV,
        listenVenues,
        addVenue,
        updateVenue,
        deleteVenue,
        exportVenuesCSV,
        listenIdeas,
        addIdea,
        toggleLike,
        deleteIdea,
        listenBudget,
        setBudgetTarget,
        addBudgetItem,
        updateBudgetItem,
        deleteBudgetItem,
      };

      window.FirebaseSession = {
        waitForAuth,
        getCurrentUser: () => auth.currentUser,
      };

      if (typeof window !== "undefined" && typeof window.dispatchEvent === "function") {
        window.dispatchEvent(new Event("firebase-sync-ready"));
      }
    </script>


    <script src="app.js" defer></script>
  </body>
</html>
