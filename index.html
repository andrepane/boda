<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nuestra boda</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app-shell">
      <div class="app">
        <header class="app__header">
          <div class="hero">
            <div class="hero__accent"></div>
            <div class="hero__content">
              <span class="hero__badge" aria-hidden="true">Organización</span>
              <h1 class="hero__title">Boda</h1>
              <p class="hero__subtitle">
                Un lugar para coordinar ideas, invitados y presupuesto con calma y estilo.
              </p>
            </div>
          </div>

          <nav class="tabs" aria-label="Secciones de la aplicacion">
            <button
              id="checklist-tab"
              class="tabs__tab is-active"
              type="button"
              data-target="checklist"
              aria-controls="checklist"
              aria-selected="true"
            >
              Checklist
            </button>
            <button
              id="ideas-tab"
              class="tabs__tab"
              type="button"
              data-target="ideas"
              aria-controls="ideas"
              aria-selected="false"
            >
              Ideas
            </button>
            <button
              id="invitados-tab"
              class="tabs__tab"
              type="button"
              data-target="invitados"
              aria-controls="invitados"
              aria-selected="false"
            >
              Invitados
            </button>
            <button
              id="presupuesto-tab"
              class="tabs__tab"
              type="button"
              data-target="presupuesto"
              aria-controls="presupuesto"
              aria-selected="false"
            >
              Presupuesto
            </button>
          </nav>
        </header>

        <main class="app__content">
          <section id="checklist" class="tab-content is-active" role="tabpanel" aria-labelledby="checklist-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Checklist</h2>
                <p class="panel__subtitle">
                  Añade tareas, marca lo completado y mantente al tanto de los pendientes.
                </p>
              </header>

              <form class="checklist__form" id="task-form" autocomplete="off">
                <div class="checklist__field checklist__field--full">
                  <label class="checklist__label" for="task-input">Tarea</label>
                  <input
                    id="task-input"
                    class="checklist__control"
                    type="text"
                    placeholder="Describe la tarea"
                    required
                  />
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-category">Categoría</label>
                  <select id="task-category" class="checklist__control" required>
                    <option value="decoracion">Decoración</option>
                    <option value="papeleo">Papeleo</option>
                    <option value="catering">Catering</option>
                    <option value="viaje-de-novios">Viaje de novios</option>
                    <option value="anillos">Anillos</option>
                    <option value="vestimenta">Vestimenta</option>
                    <option value="invitados">Invitados</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-priority">Prioridad</label>
                  <select id="task-priority" class="checklist__control" required>
                    <option value="alta">Alta</option>
                    <option value="media" selected>Media</option>
                    <option value="baja">Baja</option>
                  </select>
                </div>

                <div class="checklist__field">
                  <label class="checklist__label" for="task-deadline">Fecha límite</label>
                  <input id="task-deadline" class="checklist__control" type="date" required />
                </div>

                <button class="button checklist__submit" type="submit">Agregar</button>
              </form>

              <div class="checklist__summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Pendientes</span>
                  <strong id="pending-count" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Total</span>
                  <strong id="total-count" class="summary__value">0</strong>
                </div>
                <div class="checklist__progress">
                  <div class="progress__header">
                    <span class="summary__label">Progreso</span>
                    <strong id="progress-value" class="summary__value">0%</strong>
                  </div>
                  <div
                    id="progress-bar"
                    class="progress__bar"
                    role="progressbar"
                    aria-label="Progreso de la checklist"
                    aria-valuemin="0"
                    aria-valuemax="100"
                    aria-valuenow="0"
                  >
                    <div id="progress-fill" class="progress__fill"></div>
                  </div>
                </div>
              </div>

              <ul class="checklist__list" id="task-list"></ul>
            </div>
          </section>

          <section id="ideas" class="tab-content" role="tabpanel" aria-labelledby="ideas-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Ideas e inspiración</h2>
                <p class="panel__subtitle">
                  Guarda referencias de decoración, proveedores y detalles especiales.
                </p>
              </header>

              <form id="idea-form" class="form-grid" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-title">Título</label>
                  <input
                    id="idea-title"
                    class="form-control"
                    type="text"
                    placeholder="Centro de mesa, invitaciones…"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="idea-url">URL</label>
                  <input
                    id="idea-url"
                    class="form-control"
                    type="url"
                    placeholder="https://"
                  />
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-image">Imagen</label>
                  <input
                    id="idea-image"
                    class="form-control form-control--file"
                    type="file"
                    accept="image/*"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="idea-category">Categoría</label>
                  <input
                    id="idea-category"
                    class="form-control"
                    type="text"
                    placeholder="Decoración, música, viaje…"
                    required
                  />
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="idea-note">Nota</label>
                  <textarea
                    id="idea-note"
                    class="form-control form-control--textarea"
                    rows="2"
                    placeholder="Detalles para recordar"
                  ></textarea>
                </div>

                <button class="button form-submit" type="submit">Guardar idea</button>
              </form>

              <div class="ideas-toolbar">
                <div class="ideas-filter">
                  <label class="form-label" for="idea-search">Buscar</label>
                  <input
                    id="idea-search"
                    class="form-control"
                    type="search"
                    placeholder="Buscar por título"
                  />
                </div>

                <div class="ideas-filter">
                  <label class="form-label" for="idea-category-filter">Categoría</label>
                  <select id="idea-category-filter" class="form-control">
                    <option value="">Todas</option>
                  </select>
                </div>
              </div>

              <div id="ideas-grid" class="ideas-grid" aria-live="polite"></div>
            </div>
          </section>

          <section id="invitados" class="tab-content" role="tabpanel" aria-labelledby="invitados-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Invitados</h2>
                <p class="panel__subtitle">
                  Gestiona confirmaciones, acompañantes y notas especiales en tiempo real.
                </p>
              </header>

              <form id="guest-form" class="form-grid" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="guest-name">Nombre</label>
                  <input
                    id="guest-name"
                    class="form-control"
                    type="text"
                    placeholder="Nombre completo"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="guest-side">Lado</label>
                  <select id="guest-side" class="form-control" required>
                    <option value="novia">Novia</option>
                    <option value="novio">Novio</option>
                    <option value="ambos">Ambos</option>
                  </select>
                </div>

                <div class="form-field">
                  <label class="form-label" for="guest-group">Grupo</label>
                  <input
                    id="guest-group"
                    class="form-control"
                    type="text"
                    placeholder="Familia, amigos…"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="guest-rsvp">RSVP</label>
                  <select id="guest-rsvp" class="form-control">
                    <option value="pending">Pendiente</option>
                    <option value="yes">Confirmado</option>
                    <option value="no">Rechazado</option>
                  </select>
                </div>

                <div class="form-field">
                  <label class="form-label" for="guest-plus">Acompañantes</label>
                  <input
                    id="guest-plus"
                    class="form-control"
                    type="number"
                    min="0"
                    step="1"
                    value="0"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="guest-contact">Contacto</label>
                  <input
                    id="guest-contact"
                    class="form-control"
                    type="text"
                    placeholder="Correo o teléfono"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="guest-dietary">Restricciones</label>
                  <input
                    id="guest-dietary"
                    class="form-control"
                    type="text"
                    placeholder="Sin gluten, vegetariano…"
                  />
                </div>

                <div class="form-field form-field--full">
                  <label class="form-label" for="guest-notes">Notas</label>
                  <textarea
                    id="guest-notes"
                    class="form-control form-control--textarea"
                    rows="2"
                    placeholder="Comentarios extra"
                  ></textarea>
                </div>

                <button class="button form-submit" type="submit">Agregar invitado</button>
              </form>

              <div class="guest-summary" aria-live="polite">
                <div class="summary__item">
                  <span class="summary__label">Invitados</span>
                  <strong id="guest-total" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Confirmados</span>
                  <strong id="guest-confirmed" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Pendientes</span>
                  <strong id="guest-pending" class="summary__value">0</strong>
                </div>
                <div class="summary__item">
                  <span class="summary__label">Personas totales</span>
                  <strong id="guest-people" class="summary__value">0</strong>
                </div>
              </div>

              <div class="guest-toolbar">
                <div class="guest-filter">
                  <label class="form-label" for="guest-search">Buscar</label>
                  <input
                    id="guest-search"
                    class="form-control"
                    type="search"
                    placeholder="Buscar por nombre"
                  />
                </div>
                <div class="guest-filter">
                  <label class="form-label" for="guest-rsvp-filter">RSVP</label>
                  <select id="guest-rsvp-filter" class="form-control">
                    <option value="">Todos</option>
                    <option value="yes">Confirmados</option>
                    <option value="pending">Pendientes</option>
                    <option value="no">Rechazados</option>
                  </select>
                </div>
                <div class="guest-filter">
                  <label class="form-label" for="guest-group-filter">Grupo</label>
                  <select id="guest-group-filter" class="form-control">
                    <option value="">Todos</option>
                  </select>
                </div>
                <button id="guest-export" class="button button--ghost" type="button">
                  Exportar CSV
                </button>
              </div>

              <ul id="guest-list" class="guest-list" aria-live="polite"></ul>
            </div>
          </section>

          <section id="presupuesto" class="tab-content" role="tabpanel" aria-labelledby="presupuesto-tab">
            <div class="panel">
              <header class="panel__header">
                <h2 class="panel__title">Presupuesto</h2>
                <p class="panel__subtitle">
                  Define tu objetivo, sigue gastos estimados y reales y controla pagos.
                </p>
              </header>

              <form id="budget-target-form" class="budget-target" autocomplete="off">
                <label class="form-label" for="budget-target">Objetivo general</label>
                <div class="budget-target__controls">
                  <input
                    id="budget-target"
                    class="form-control"
                    type="number"
                    min="0"
                    step="0.01"
                    placeholder="0"
                  />
                  <button class="button button--compact" type="submit">Guardar objetivo</button>
                </div>
              </form>

              <div class="budget-summary" aria-live="polite">
                <div class="budget-summary__item">
                  <span class="summary__label">Objetivo</span>
                  <strong id="budget-target-value" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Estimado</span>
                  <strong id="budget-estimated" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Real</span>
                  <strong id="budget-actual" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Pagado</span>
                  <strong id="budget-paid" class="summary__value">0</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">% Pagado</span>
                  <strong id="budget-paid-percent" class="summary__value">0%</strong>
                </div>
                <div class="budget-summary__item">
                  <span class="summary__label">Diferencia</span>
                  <strong id="budget-diff" class="summary__value">0</strong>
                </div>
              </div>

              <form id="budget-item-form" class="form-grid budget-item-form" autocomplete="off">
                <div class="form-field form-field--full">
                  <label class="form-label" for="budget-title">Concepto</label>
                  <input
                    id="budget-title"
                    class="form-control"
                    type="text"
                    placeholder="Catering, música, flores…"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-category">Categoría</label>
                  <input
                    id="budget-category"
                    class="form-control"
                    type="text"
                    placeholder="Catering, foto…"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-estimate">Estimado</label>
                  <input
                    id="budget-estimate"
                    class="form-control"
                    type="number"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-actual-input">Real</label>
                  <input
                    id="budget-actual-input"
                    class="form-control"
                    type="number"
                    min="0"
                    step="0.01"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-provider">Proveedor</label>
                  <input
                    id="budget-provider"
                    class="form-control"
                    type="text"
                    placeholder="Nombre o contacto"
                  />
                </div>

                <div class="form-field">
                  <label class="form-label" for="budget-date">Fecha</label>
                  <input id="budget-date" class="form-control" type="date" />
                </div>

                <button class="button form-submit" type="submit">Agregar gasto</button>
              </form>

              <div class="budget-toolbar">
                <div class="budget-filter">
                  <label class="form-label" for="budget-category-filter">Categoría</label>
                  <select id="budget-category-filter" class="form-control">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="budget-filter">
                  <label class="form-label" for="budget-paid-filter">Pagado</label>
                  <select id="budget-paid-filter" class="form-control">
                    <option value="">Todos</option>
                    <option value="paid">Pagados</option>
                    <option value="pending">Pendientes</option>
                  </select>
                </div>
              </div>

              <div class="table-wrapper">
                <table class="budget-table" aria-describedby="presupuesto-tab">
                  <thead>
                    <tr>
                      <th scope="col">Concepto</th>
                      <th scope="col">Categoría</th>
                      <th scope="col">Estimado</th>
                      <th scope="col">Real</th>
                      <th scope="col">
                        <span aria-hidden="true">Δ</span>
                        <span class="visually-hidden">Diferencia</span>
                      </th>
                      <th scope="col">Pagado</th>
                      <th scope="col">Fecha</th>
                      <th scope="col">Proveedor</th>
                      <th scope="col" class="visually-hidden">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="budget-table-body"></tbody>
                </table>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script>
      // ⚠️ Rellena con TUS credenciales reales. MUY IMPORTANTE: añade también databaseURL.
      // - databaseURL: cópiala desde Firebase → Realtime Database → pestaña "Data".
      // - storageBucket debe acabar en .appspot.com
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyCKHtBq_JjgYSy-lpnpka8jNpaW4GbMefU",
        authDomain: "boda-f0cac.firebaseapp.com",
        databaseURL: "https://boda-f0cac-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "boda-f0cac",
        storageBucket: "boda-f0cac.appspot.com",
        messagingSenderId: "764003731377",
        appId: "1:764003731377:web:5dccc6fa01c0409121df90",
        // measurementId opcional
      };

      // Encendido / apagado de la sync remota sin tocar más código
      window.ENABLE_SYNC = true;

      // Sala compartida entre vosotros
      window.DEFAULT_ROOM_ID = "andrea-boda";
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        push,
        update,
        remove,
        onValue,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      const firebaseConfig = window.FIREBASE_CONFIG;
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const ROOM = window.DEFAULT_ROOM_ID || "andrea-boda";
      const tasksPath = `rooms/${ROOM}/tasks`;
      const guestsPath = `rooms/${ROOM}/guests`;
      const ideasPath = `rooms/${ROOM}/ideas`;
      const budgetPath = `rooms/${ROOM}/budget`;
      const budgetMetaPath = `${budgetPath}/meta`;
      const budgetItemsPath = `${budgetPath}/items`;

      function ensureSync() {
        if (!window.ENABLE_SYNC) {
          throw new Error("SYNC_OFF");
        }
      }

      let resolveAuthReady;
      let rejectAuthReady;
      const authReadyPromise = new Promise((resolve, reject) => {
        resolveAuthReady = resolve;
        rejectAuthReady = reject;
      });

      signInAnonymously(auth).catch((error) => {
        console.error("Error al iniciar sesión de forma anónima.", error);

        if (typeof rejectAuthReady === "function") {
          rejectAuthReady(error);
          resolveAuthReady = null;
          rejectAuthReady = null;
        }
      });

      onAuthStateChanged(
        auth,
        (user) => {
          if (user && user.uid) {
            console.debug("Firebase Auth listo. UID:", user.uid);

            if (typeof resolveAuthReady === "function") {
              resolveAuthReady(user);
              resolveAuthReady = null;
              rejectAuthReady = null;
            }
          }
        },
        (error) => {
          console.error("Error al observar el estado de autenticación.", error);

          if (typeof rejectAuthReady === "function") {
            rejectAuthReady(error);
            resolveAuthReady = null;
            rejectAuthReady = null;
          }
        },
      );

      const waitForAuth = () => authReadyPromise;

      export function listenTasks(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const tasksRef = ref(db, tasksPath);
            unsubscribe = onValue(
              tasksRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en las tareas de Firebase.", error);
              },
            );
          })
          .catch((error) => {
            console.error(
              "No se pudo iniciar la escucha de tareas porque la autenticación falló.",
              error,
            );
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addTask(task) {
        await waitForAuth();
        ensureSync();

        const tasksRef = ref(db, tasksPath);
        const payload = {
          description: String(task.description ?? "").trim(),
          category: task.category ?? "otro",
          priority: task.priority ?? "media",
          dueDate: task.dueDate ?? "",
          completed: Boolean(task.completed),
          createdAt:
            typeof task.createdAt === "number" && Number.isFinite(task.createdAt)
              ? task.createdAt
              : Date.now(),
          updatedAt:
            typeof task.updatedAt === "number" && Number.isFinite(task.updatedAt)
              ? task.updatedAt
              : Date.now(),
          id: typeof task.id === "string" && task.id ? task.id : null,
        };

        try {
          await push(tasksRef, payload);
        } catch (error) {
          console.error("No se pudo crear la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function toggleTask(taskId, completed) {
        await waitForAuth();
        ensureSync();

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await update(taskRef, {
            completed: Boolean(completed),
            updatedAt: Date.now(),
          });
        } catch (error) {
          console.error("No se pudo actualizar la tarea en Firebase.", error);
          throw error;
        }
      }

      export async function deleteTask(taskId) {
        await waitForAuth();
        ensureSync();

        const taskRef = ref(db, `${tasksPath}/${taskId}`);

        try {
          await remove(taskRef);
        } catch (error) {
          console.error("No se pudo eliminar la tarea en Firebase.", error);
          throw error;
        }
      }

      const RSVP_VALUES = new Set(["pending", "yes", "no"]);
      const SIDE_VALUES = new Set(["novia", "novio", "ambos"]);

      const sanitizeText = (value) =>
        typeof value === "string" ? value.trim() : typeof value === "number" ? String(value).trim() : "";

      const normalizePlusOnes = (value) => {
        if (typeof value === "number" && Number.isFinite(value)) {
          return Math.max(0, Math.trunc(value));
        }

        if (typeof value === "string") {
          const parsed = Number.parseInt(value, 10);
          if (Number.isFinite(parsed)) {
            return Math.max(0, parsed);
          }
        }

        return 0;
      };

      const normalizeRsvp = (value) => (RSVP_VALUES.has(value) ? value : "pending");

      const normalizeSide = (value) => (SIDE_VALUES.has(value) ? value : "ambos");

      const toTimestampValue = (value, fallback) =>
        typeof value === "number" && Number.isFinite(value) ? value : fallback;

      export function listenGuests(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const guestsRef = ref(db, guestsPath);
            unsubscribe = onValue(
              guestsRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en invitados.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de invitados.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addGuest(guest) {
        await waitForAuth();
        ensureSync();

        const guestsRef = ref(db, guestsPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const name = sanitizeText(guest?.name);

        if (!name) {
          throw new Error("NAME_REQUIRED");
        }

        const payload = {
          name,
          side: normalizeSide(guest?.side),
          group: sanitizeText(guest?.group),
          rsvp: normalizeRsvp(guest?.rsvp),
          plusOnes: normalizePlusOnes(guest?.plusOnes),
          dietary: sanitizeText(guest?.dietary),
          notes: sanitizeText(guest?.notes),
          contact: sanitizeText(guest?.contact),
          createdAt: toTimestampValue(guest?.createdAt, now),
          updatedAt: toTimestampValue(guest?.updatedAt, now),
          createdBy:
            sanitizeText(guest?.createdBy) || (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        try {
          await push(guestsRef, payload);
        } catch (error) {
          console.error("No se pudo crear el invitado en Firebase.", error);
          throw error;
        }
      }

      export async function updateGuest(guestId, changes) {
        await waitForAuth();
        ensureSync();

        const guestRef = ref(db, `${guestsPath}/${guestId}`);
        const updatePayload = {};

        if (typeof changes?.name === "string") {
          const trimmed = changes.name.trim();
          if (trimmed) {
            updatePayload.name = trimmed;
          }
        }

        if (typeof changes?.group === "string") {
          updatePayload.group = changes.group.trim();
        }

        if (typeof changes?.contact === "string") {
          updatePayload.contact = changes.contact.trim();
        }

        if (typeof changes?.dietary === "string") {
          updatePayload.dietary = changes.dietary.trim();
        }

        if (typeof changes?.notes === "string") {
          updatePayload.notes = changes.notes.trim();
        }

        if (typeof changes?.side === "string") {
          updatePayload.side = normalizeSide(changes.side);
        }

        if (typeof changes?.rsvp === "string") {
          updatePayload.rsvp = normalizeRsvp(changes.rsvp);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "plusOnes")) {
          updatePayload.plusOnes = normalizePlusOnes(changes.plusOnes);
        }

        updatePayload.updatedAt = Date.now();

        try {
          await update(guestRef, updatePayload);
        } catch (error) {
          console.error("No se pudo actualizar el invitado en Firebase.", error);
          throw error;
        }
      }

      export async function deleteGuest(guestId) {
        await waitForAuth();
        ensureSync();

        const guestRef = ref(db, `${guestsPath}/${guestId}`);

        try {
          await remove(guestRef);
        } catch (error) {
          console.error("No se pudo eliminar el invitado en Firebase.", error);
          throw error;
        }
      }

      const escapeCsvCell = (value) => {
        if (value === null || value === undefined) {
          return "";
        }

        const stringValue = String(value).replace(/[\r\n]+/g, " ").trim();
        if (stringValue === "") {
          return "";
        }

        if (/[",;]/.test(stringValue)) {
          return `"${stringValue.replace(/"/g, '""')}"`;
        }

        return stringValue;
      };

      const formatCsvDate = (timestamp) => {
        if (typeof timestamp !== "number" || !Number.isFinite(timestamp)) {
          return "";
        }

        try {
          return new Date(timestamp).toISOString();
        } catch (error) {
          return "";
        }
      };

      export function exportGuestsCSV(guestsObj) {
        const headers = [
          "ID",
          "Nombre",
          "Lado",
          "Grupo",
          "RSVP",
          "Acompañantes",
          "Personas totales",
          "Restricciones",
          "Notas",
          "Contacto",
          "Creado",
          "Actualizado",
          "Creado por",
        ];

        const rows = [headers];

        if (guestsObj && typeof guestsObj === "object") {
          Object.entries(guestsObj).forEach(([id, record]) => {
            if (!record || typeof record !== "object") {
              return;
            }

            const plusOnes = normalizePlusOnes(record.plusOnes);
            const totalPeople = 1 + plusOnes;

            rows.push([
              id,
              sanitizeText(record.name),
              normalizeSide(record.side),
              sanitizeText(record.group),
              normalizeRsvp(record.rsvp),
              plusOnes,
              totalPeople,
              sanitizeText(record.dietary),
              sanitizeText(record.notes),
              sanitizeText(record.contact),
              formatCsvDate(record.createdAt),
              formatCsvDate(record.updatedAt),
              sanitizeText(record.createdBy),
            ]);
          });
        }

        return rows.map((row) => row.map((cell) => escapeCsvCell(cell)).join(",")).join("\n");
      }

      export function listenIdeas(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const ideasRef = ref(db, ideasPath);
            unsubscribe = onValue(
              ideasRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                callback(value);
              },
              (error) => {
                console.error("Error al escuchar cambios en ideas.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de ideas.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      export async function addIdea(idea, uid) {
        await waitForAuth();
        ensureSync();

        const ideasRef = ref(db, ideasPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const title = sanitizeText(idea?.title);

        if (!title) {
          throw new Error("TITLE_REQUIRED");
        }

        const urlValue = sanitizeText(idea?.url);

        const payload = {
          title,
          url: urlValue || "",
          category: sanitizeText(idea?.category) || "Sin categoría",
          note: sanitizeText(idea?.note),
          likes: idea?.likes && typeof idea.likes === "object" ? idea.likes : {},
          createdAt: toTimestampValue(idea?.createdAt, now),
          updatedAt: toTimestampValue(idea?.updatedAt, now),
          createdBy:
            sanitizeText(idea?.createdBy) || uid || (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        try {
          await push(ideasRef, payload);
        } catch (error) {
          console.error("No se pudo crear la idea en Firebase.", error);
          throw error;
        }
      }

      export async function toggleLike(ideaId, uid, isLiked) {
        await waitForAuth();
        ensureSync();

        if (!ideaId || !uid) {
          throw new Error("LIKE_DATA_MISSING");
        }

        const ideaRef = ref(db, `${ideasPath}/${ideaId}`);
        const updates = { updatedAt: Date.now() };

        updates[`likes/${uid}`] = isLiked ? null : true;

        try {
          await update(ideaRef, updates);
        } catch (error) {
          console.error("No se pudo actualizar el like en Firebase.", error);
          throw error;
        }
      }

      export async function deleteIdea(ideaId) {
        await waitForAuth();
        ensureSync();

        const ideaRef = ref(db, `${ideasPath}/${ideaId}`);

        try {
          await remove(ideaRef);
        } catch (error) {
          console.error("No se pudo eliminar la idea en Firebase.", error);
          throw error;
        }
      }

      export function listenBudget(callback) {
        if (!window.ENABLE_SYNC) {
          console.warn("La sincronización remota está desactivada.");
          return () => {};
        }

        let unsubscribe = () => {};

        waitForAuth()
          .then(() => {
            if (!window.ENABLE_SYNC) {
              console.warn("La sincronización remota está desactivada.");
              return;
            }

            const budgetRef = ref(db, budgetPath);
            unsubscribe = onValue(
              budgetRef,
              (snapshot) => {
                const value = snapshot.val() ?? {};
                const meta = value.meta ?? {};
                const items = value.items ?? {};
                callback({ meta, items });
              },
              (error) => {
                console.error("Error al escuchar cambios en presupuesto.", error);
              },
            );
          })
          .catch((error) => {
            console.error("No se pudo iniciar la escucha de presupuesto.", error);
          });

        return () => {
          if (typeof unsubscribe === "function") {
            unsubscribe();
          }
        };
      }

      const normalizeAmount = (value) => {
        if (typeof value === "number" && Number.isFinite(value)) {
          return Number.parseFloat(value.toFixed(2));
        }

        if (typeof value === "string") {
          const cleaned = value.replace(/,/g, ".");
          const parsed = Number.parseFloat(cleaned);
          if (Number.isFinite(parsed)) {
            return Number.parseFloat(parsed.toFixed(2));
          }
        }

        return 0;
      };

      export async function setBudgetTarget(target) {
        await waitForAuth();
        ensureSync();

        const value = normalizeAmount(target);
        const payload = { target: value, updatedAt: Date.now() };

        try {
          await update(ref(db, budgetMetaPath), payload);
        } catch (error) {
          console.error("No se pudo actualizar el objetivo de presupuesto en Firebase.", error);
          throw error;
        }
      }

      export async function addBudgetItem(item) {
        await waitForAuth();
        ensureSync();

        const itemsRef = ref(db, budgetItemsPath);
        const now = Date.now();
        const currentUser = auth.currentUser;
        const title = sanitizeText(item?.title);

        if (!title) {
          throw new Error("TITLE_REQUIRED");
        }

        const payload = {
          title,
          category: sanitizeText(item?.category) || "General",
          est: normalizeAmount(item?.est),
          act: normalizeAmount(item?.act),
          paid: Boolean(item?.paid),
          dueDate: sanitizeText(item?.dueDate),
          provider: sanitizeText(item?.provider),
          createdAt: toTimestampValue(item?.createdAt, now),
          updatedAt: toTimestampValue(item?.updatedAt, now),
          createdBy:
            sanitizeText(item?.createdBy) || (currentUser && currentUser.uid ? currentUser.uid : null),
        };

        try {
          await push(itemsRef, payload);
        } catch (error) {
          console.error("No se pudo crear el gasto en Firebase.", error);
          throw error;
        }
      }

      export async function updateBudgetItem(itemId, changes) {
        await waitForAuth();
        ensureSync();

        const itemRef = ref(db, `${budgetItemsPath}/${itemId}`);
        const payload = { updatedAt: Date.now() };

        if (typeof changes?.title === "string" && changes.title.trim()) {
          payload.title = changes.title.trim();
        }

        if (typeof changes?.category === "string") {
          payload.category = changes.category.trim();
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "est")) {
          payload.est = normalizeAmount(changes.est);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "act")) {
          payload.act = normalizeAmount(changes.act);
        }

        if (Object.prototype.hasOwnProperty.call(changes ?? {}, "paid")) {
          payload.paid = Boolean(changes.paid);
        }

        if (typeof changes?.dueDate === "string") {
          payload.dueDate = changes.dueDate.trim();
        }

        if (typeof changes?.provider === "string") {
          payload.provider = changes.provider.trim();
        }

        try {
          await update(itemRef, payload);
        } catch (error) {
          console.error("No se pudo actualizar el gasto en Firebase.", error);
          throw error;
        }
      }

      export async function deleteBudgetItem(itemId) {
        await waitForAuth();
        ensureSync();

        const itemRef = ref(db, `${budgetItemsPath}/${itemId}`);

        try {
          await remove(itemRef);
        } catch (error) {
          console.error("No se pudo eliminar el gasto en Firebase.", error);
          throw error;
        }
      }

      window.FirebaseSync = {
        listenTasks,
        addTask,
        toggleTask,
        deleteTask,
        listenGuests,
        addGuest,
        updateGuest,
        deleteGuest,
        exportGuestsCSV,
        listenIdeas,
        addIdea,
        toggleLike,
        deleteIdea,
        listenBudget,
        setBudgetTarget,
        addBudgetItem,
        updateBudgetItem,
        deleteBudgetItem,
      };

      window.FirebaseSession = {
        waitForAuth,
        getCurrentUser: () => auth.currentUser,
      };

      if (typeof window !== "undefined" && typeof window.dispatchEvent === "function") {
        window.dispatchEvent(new Event("firebase-sync-ready"));
      }
    </script>


    <script src="app.js" defer></script>
  </body>
</html>


